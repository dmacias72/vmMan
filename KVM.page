Cond="(pgrep('libvirtd')!==FALSE)"
Icon="icons/default.png"
Menu="Tasks:70"
Type="xmenu"
---
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="/plugins/vmMan/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<script type="text/javascript" src="/plugins/vmMan/bootstrap/js/bootstrap.min.js"></script>
<link href="/plugins/vendor/normalize/normalize.css" rel="stylesheet" type="text/css"></link>
<link href="/plugins/webGui/style/default_layout.css" rel="stylesheet" type="text/css"></link>
</head>

<?php
	require_once('/usr/local/emhttp/plugins/vmMan/include.php');
   $ret = false;
   $clrh = false;
   if ($action) {
     	$domName = $lv->domain_get_name_by_uuid($_GET['uuid']);
      if ($action == 'domain-start') {
        	$ret = $lv->domain_start($domName) ? 
        		"Domain $domName has been started successfully" : 
        		'Error while starting domain: '.$lv->get_last_error();
			$clrh=true; }
      elseif ($action == 'domain-pause') {
        	$ret = $lv->domain_suspend($domName) ? 
  	      	"Domain $domName has been paused successfully" : 
   	     	'Error while pausing domain: '.$lv->get_last_error();
			$clrh=true; }
      elseif ($action == 'domain-resume') {
      	$ret = $lv->domain_resume($domName) ? 
      		"Domain $domName has been resumed successfully" : 
      		'Error while resuming domain: '.$lv->get_last_error();
			$clrh=true; }
      elseif ($action == 'domain-restart') {
        	$ret = $lv->domain_reboot($domName) ? 
        		"Domain $domName has been restarted successfully" : 
        		'Error while restarting domain: '.$lv->get_last_error();
			$clrh=true; }
		elseif ($action == 'domain-stop') {
         $ret = $lv->domain_shutdown($domName) ? 
         	"Domain $domName has been stopped successfully" : 
         	'Error while stopping domain: '.$lv->get_last_error();
        	$clrh = true; }
      elseif ($action == 'domain-destroy') {
         $ret = $lv->domain_destroy($domName) ? 
         	"Domain $domName has been destroyed successfully" : 
         	'Error while destroying domain: '.$lv->get_last_error();
      	$clrh = true; }
      elseif ($action == 'domain-undefine') {
         $lv->domain_undefine($domName) ? 
         	$ret = "Domain $domName has been undefined successfully" : 
         	$ret = 'Error while undefining domain: '.$lv->get_last_error();
      	$clrh = true; }
      elseif ($action == 'domain-define') {
         if (@$_POST['xmldesc']) {
      	   $lv->domain_define( $_POST['xmldesc']) ? 
   	        	$ret = "Domain definition has been added" : 
   	        	$ret = 'Error adding domain definition: '.$lv->get_last_error();
            $clrh = true;
         }
         else
            $ret = "<script type=\"text/javascript\"> $(window).load(function(){ $('#editXMLDialog').modal('show'); }); </script>";
         }
         //Get domain XML
         elseif (($action == 'domain-get-xml') || ($action == 'domain-edit')) {
         	$inactive = (!$lv->domain_is_running($res, $name)) ? true : false;
            $xml = $lv->domain_get_xml($domName, $inactive);
            if ($action == 'domain-edit') {
            	if (@$_POST['xmldesc']) {
               	$ret = $lv->domain_change_xml($domName, $_POST['xmldesc']) ? 
               	"Domain definition has been changed" :
                  'Error changing domain definition: '.$lv->get_last_error();
            	}
               else
               	$ret = "<script type=\"text/javascript\"> $(window).load(function(){ $('#editXMLDialog').modal('show'); }); </script>";
            }
            else
            	$ret = "Domain XML for domain <i>$domName</i>:<br /><br />".htmlentities($xml);
			}
         elseif($action == 'nodes') {
         	$ret = "<script type=\"text/javascript\"> $(window).load(function(){ $('#nodes').modal('show'); }); </script>";
            }
        	}
        	$tmp = $lv->get_domain_count();
			$doms = $lv->get_domains();
         $domkeys = array_keys($doms);
         $active = $tmp['active'];
			$host = gethostname();
            //Create nav bar		
			echo "<div class=\"wrap\">
						<div class=\"info\">
  				 			<p>
  						   	Statistics: {$tmp['total']} domains, {$tmp['active']} active, {$tmp['inactive']} inactive
   			   		</p>
   	 				  	<p>
  			 			   	<div class=\"btn-group btn-group-sm\">
	   		  		 	      <div class=\"btn-group\">
   			  		 	      	<button class=\"btn btn-primary\" data-toggle=\"modal\" 
   			  		 	      	data-target=\"#vmcreate\" href=\"plugins/vmMan/vmcreate.php\" 
   			  		 	      	title=\"create domain from template\"><i class=\"glyphicon glyphicon-plus\">
   		  			 	      	</i>&#32;Create</button>
   		  			 	      </div>
   		  	 	 		  	   <div class=\"btn-group\">
	   		  	 	 	  	   	<button class=\"btn btn-info\" data-toggle=\"modal\" 
   			  	 	 	  	   	data-target=\"#networks\" href=\"/plugins/vmMan/networks.php\" 
   			  	 	 	  	   	title=\"display network information\"><i class=\"glyphicon glyphicon-globe\">
   			  	 	 	  	   	</i>&#32;Networks</button>
   		  		 	 	  	   </div>
   		    			      <div class=\"btn-group\"><button class=\"btn btn-warning\"  
	   		    			      onclick=\"javascript:location.href='?action=nodes&cap= '\" 
   			    			      title=\"display device node information\"><i class=\"glyphicon glyphicon-stats\">
   			    			      </i>&#32;Nodes</button>
   		    		  	   	</div>
   	  	   	   			<div class=\"btn-group\"><button class=\"btn btn-success\" data-toggle=\"modal\" 
	   	  	   	   			data-target=\"#storage\" href=\"/plugins/vmMan/storage.php\" 
   		  	   	  		 		title=\"display storage information\"><i class=\"glyphicon glyphicon-hdd\">
   		  	   	   			</i>&#32;Storage</button>
   	  	   	   			</div>
   		  		 	      	<div class=\"btn-group\">
	   		  		 	      	<button class=\"btn btn-primary\" 
   			  		 	      	onclick=\"javascript:location.href='?action=domain-define&amp;vmname=new'\" 
   			  		 	      	title=\"add domain from XML\"><i class=\"glyphicon glyphicon-plus\">
   			  		 	      	</i>&#32;XML</button>
  		  			 	      	</div>
     		 			 	   	<div class=\"btn-group\"><button class=\"btn btn-info\" data-toggle=\"modal\" 
     		 		 		   		data-target=\"#hostinfo\" href=\"/plugins/vmMan/hostinfo.php\" 
     		 		 	   			title=\"display host information\"><i class=\"glyphicon glyphicon-info-sign\">
     		 		 	   			</i>&#32;Info</button>
	     		 		 	   	</div>
								</p>      	
		     			</div>
					</div>
				<div class=\"list\">
					<table class=\"table table-striped\">
  	      			<tr>
  		          		<th>Name</th>
   	         	   <th>CPU#</th>
      	        		<th>RAM</th>
         	     		<th>Hard Drive(s)</th>
           	   		<th>NICs</th>
            	  		<th>System</th>
              			<th>State</th>
              		 	<th>ID / WS Port</th>
              			<th>Operation</th>
            		</tr>";
			//Get domain variables for each domain
         for ($i = 0; $i < sizeof($doms); $i++) {
         	$name = $doms[$i];
            $res = $lv->get_domain_by_name($name);
            $uuid = libvirt_domain_get_uuid_string($res);
            $dom = $lv->domain_get_info($res);
            $mem = number_format($dom['memory'] / 1024000, 1, '.', ' ').' GB';
            $cpu = $dom['nrVirtCpu'];
            $state = $lv->domain_state_translate($dom['state']);
				if ($state == 'running')
				 	$scolor = 'LimeGreen';
				elseif($state == 'shutoff')
				 	$scolor = 'Red';
				else 
              	$scolor = 'Orange';               
            $id = $lv->domain_get_id($res);
            $arch = $lv->domain_get_arch($res);
            $vnc = $lv->domain_get_vnc_port($res);
            $port = (int)$vnc - 200;
				$nics = $lv->get_network_cards($res);
            if (($diskcnt = $lv->get_disk_count($res)) > 0) {
            	$disks = $diskcnt.' / '.$lv->get_disk_capacity($res);
               $diskdesc = 'Current physical size: '.$lv->get_disk_capacity($res, true);
            }
            else {
            	$disks = '-';
               $diskdesc = '';
            }
				if ($vnc < 0){
            	$vnc = '-';
            	$vncport = $vnc;
            }else{
            	$vncport = (int)$vnc -200;
               $vnc = '/plugins/vmMan/vnc_auto.html?autoconnect=true&host='.$host.'&port='.$vncport;
            }

            unset($tmp);
            if (!$id)
            	$id = '-';
            unset($dom);

				//Domain information
            echo "<tr>
            	      <td>
                       	<a href=\"/plugins/vmMan/dominfo.php?uuid=$uuid&amp;vmname=$name\" data-toggle=\"modal\" data-target=\"#dominfo\">$name</a>
                     </td>
                     <td>$cpu</td>
                     <td>$mem</td>
                     <td title='$diskdesc'>$disks</td>
                     <td>$nics</td>
                     <td>$arch</td>
                     <td><font color=\"$scolor\">$state</font></td>
                     <td>$id / $vncport</td>";

            echo "<td>";
					
				//Domain Action Buttons
            if ($lv->domain_is_running($res, $name)){
					echo "<button class=\"btn btn-sm btn-primary\" onclick=\"javascript:window.open('$vnc');\" 
               			title=\"open VNC connection\"><i class=\"glyphicon glyphicon-eye-open\"></i></button> | 
                 		<button class=\"btn btn-sm\" onclick=\"javascript:location.href='?action=domain-pause&amp;uuid=$uuid'\" 
                 			title=\"Pause domain\"><i class=\"glyphicon glyphicon-pause\"></i></button> | 
                 		<button class=\"btn btn-sm btn-info\" onclick=\"javascript:location.href='?action=domain-restart&amp;uuid=$uuid'\" 
              				title=\"restart domain\"><i class=\"glyphicon glyphicon-refresh\"></i></button> | 
              			<button class=\"btn btn-sm btn-warning\" onclick=\"javascript:location.href='?action=domain-stop&amp;uuid=$uuid'\" 
              				title=\"safely shutdown domain\"><i class=\"glyphicon glyphicon-stop\"></i></button> | 
                   	<button class=\"btn btn-sm btn-danger\" onclick=\"javascript:location.href='?action=domain-destroy&amp;uuid=$uuid'\" 
                    		title=\"force domain to shutdown\"><i class=\"glyphicon glyphicon-eject\"></i></button>";
            }else {
              	if ($state == "paused")
              		echo "<button class=\"btn btn-sm btn-success\" onclick=\"javascript:location.href='?action=domain-resume&amp;uuid=$uuid'\" 
              				title=\"resume domain\"><i class=\"glyphicon glyphicon-play\"></i></button>";
					else
              		echo "<button class=\"btn btn-sm btn-success\" onclick=\"javascript:location.href='?action=domain-start&amp;uuid=$uuid'\" 
              				title=\"start domain\"><i class=\"glyphicon glyphicon-play\"></i></button>";
				}
            if (!$lv->domain_is_running($res, $name))
                echo " | <button class=\"btn btn-sm btn-danger\" onclick=\"javascript:location.href='?action=domain-undefine&uuid=$uuid'\" 
                 		 title=\"delete domain definition\"><i class=\"glyphicon glyphicon-remove\"></i></button>";
		      echo " | <button class=\"btn btn-sm btn-primary\" onclick=\"javascript:location.href='?action=domain-edit&amp;uuid=$uuid &amp;vmname=$name'\" 
		          		title=\"edit domain XML\"><i class=\"glyphicon glyphicon-plus\"></i></button>";
            echo "</td></tr>";
         }
         echo  "</table>";
 			if ($ret)
				echo $ret;
		echo "</div>";
		
if ($clrh) echo "<script type=\"text/javascript\">	window.history.pushState('KVM', 'Title', '/KVM'); </script>";
?>	
 

<!-- Create VM Modal -->
<div class="modal fade" id="vmcreate" tabindex="-1" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			Loading...
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div>

<!-- Edit XML Dialog -->
<div class="modal fade" id="editXMLDialog" tabindex="-1" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">
				<span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
				<h4 class="modal-title" id="editXMLDialogLabel">Edit <?=$_GET['vmname'];?> Virtual Machine XML</h4>
			</div>
			<div class="modal-body">
   			<?php
	      		echo '<form method="POST" id="editXML">
	      				<textarea id="xmldesc" name="xmldesc" rows="20" style="width:100%">';
  	    			echo $xml;
  	    			echo'</textarea>
  	    					<div align="right">
  	    						<input type="submit" class="btn btn-sm btn-default" value="Save">
  	    						<button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Cancel</button>
							</div></form>';
  				?>  
			</div> 
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div>

<!-- Network information Modal -->
<div class="modal fade" id="networks" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			Loading...
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div>

<!-- Device Node information -->
<div class="modal" id="nodes" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	<h4 class="modal-title" id="nodes"><img src="/plugins/webGui/icons/settings.png" class="icon" width="16" height="16">Device Node information</h4>
</div>
<div class="modal-body">
	<div class="wrap">
   	<div class="list">
			<?php
				$ret = false;
				if (array_key_exists('subaction', $_GET)) {
					$name = $_GET['name'];
					if ($_GET['subaction'] == 'dumpxml')
						$ret ="<script type=\"text/javascript\"> $(window).load(function(){ $('#viewXMLDialog').modal('show'); }); </script>"; 
				}
				$cap = $_GET['cap'];
				echo "<div class=\"btn-group btn-group-sm\">";
				if ($cap == "")
					echo "<a class=\"btn btn-primary\" href=\"?action=nodes&amp;cap={$tmp[0]}\">all</a>";
				else
					echo "<a class=\"btn btn-default\" href=\"?action=nodes&amp;cap={$tmp[0]}\">all</a>";
				$tmp = $lv->get_node_device_cap_options();
				for ($i = 0; $i < sizeof($tmp); $i++) {
					$tmpcap = $tmp[$i];		
					if ($cap == $tmpcap )			
						echo "<a class=\"btn btn-primary\" href=\"?action=nodes&amp;cap=$tmpcap\">$tmpcap</a>";
					else
						echo "<a class=\"btn btn-default\" href=\"?action=nodes&amp;cap=$tmpcap\">$tmpcap</a>";
				}
				echo "<br /><br /></div>";

				$tmp = $lv->get_node_devices( array_key_exists('cap', $_GET) ? $_GET['cap'] : false );
				echo "<table class=\"table-striped\">
					<tr>
					 <th> Device </th>
					 <th> Identification </th>
					 <th> Driver </th>
					 <th> Vendor </th>
					 <th> Product </th>
					 <th> XML </th>
					</tr>";
				//create device node information  and buttons for each device
				for ($i = 0; $i < sizeof($tmp); $i++) {
					$tmp2 = $lv->get_node_device_information($tmp[$i]);
					
					$act = !array_key_exists('cap', $_GET) ? "<a href=\"?action={$_GET['action']}&amp;subaction=dumpxml&amp;name={$tmp2['name']}\"><i class=\"glyphicon glyphicon-download\"></i></a>" :
					   "<a href=\"?subaction=dumpxml&amp;cap={$_GET['cap']}&amp;name={$tmp2['name']}\"><i class=\"glyphicon glyphicon-download\"></i></a>";  
					if ($tmp2['capability'] == 'system') {
						$driver = '-';
						$vendor = array_key_exists('hardware_vendor', $tmp2) ? $tmp2['hardware_vendor'] : '';
						$serial = array_key_exists('hardware_version', $tmp2) ? $tmp2['hardware_version'] : '';
						$ident = $vendor.' '.$serial;
						$product = array_key_exists('hardware_serial', $tmp2) ? $tmp2['hardware_serial'] : 'Unknown';
					}
					else
					if ($tmp2['capability'] == 'net') {
						$ident = array_key_exists('interface_name', $tmp2) ? $tmp2['interface_name'] : '-';
						$driver = array_key_exists('capabilities', $tmp2) ? $tmp2['capabilities'] : '-';
						$vendor = 'Unknown';
						$product = 'Unknown';
					}
					else {
						$driver  = array_key_exists('driver_name', $tmp2) ? $tmp2['driver_name'] : 'None';
						$vendor  = array_key_exists('vendor_name', $tmp2) ? $tmp2['vendor_name'] : 'Unknown';
						$product = array_key_exists('product_name', $tmp2) ? $tmp2['product_name'] : 'Unknown';
						if (array_key_exists('vendor_id', $tmp2) && array_key_exists('product_id', $tmp2))
							$ident = $tmp2['vendor_id'].':'.$tmp2['product_id'];
						else
							$ident = '-';
					}

					echo "<tr>
							<td>{$tmp2['name']}</td>
							<td>$ident</td>
							<td>$driver</td>
							<td>$vendor</td>
							<td>$product</td>
							<td>$act</td>
			      		</tr>";
				}
				echo "</table>";
				if ($ret)
					echo $ret;
			?>
		</div>
	</div>
</div><!-- /.modal-body -->
<div class="modal-footer">
	<button type="button" class="btn btn-default" data-dismiss="modal">Close</button> 
</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div>

<!-- View XML Dialog -->
<div class="modal" id="viewXMLDialog" >
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">
				<span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
				<h4 class="modal-title" id="viewXMLDialog">XML dump of device <i><?=$name?></i></h4>
			</div>
			<div class="modal-body">
				<?php
				echo htmlentities($lv->get_node_device_xml($name, false));
				?>
			</div><!-- /.modal-body -->
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div>

<!-- Storage information -->
<div class="modal fade" id="storage">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			Loading...
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div>

<!-- Host information -->
<div class="modal fade" id="hostinfo">
	<div class="modal-dialog">
		<div class="modal-content">
			Loading...
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div>

<!-- Domain information -->
<div class="modal fade" id="dominfo">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			Loading...
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div>

<script type="text/javascript" >
$('#editXMLDialog').on('hidden.bs.modal', function () {
	window.history.pushState('KVM', 'Title', '/KVM');  
});

$('#dominfo').on('hidden.bs.modal', function () {
  $(this).removeData('bs.modal');
});

$('#nodes').on('hidden.bs.modal', function () {
  $(this).removeData('bs.modal');
	window.history.pushState('KVM', 'Title', '/KVM');  
});

$('#viewXMLDialog').on('hidden.bs.modal', function () {
	$(this).removeData('bs.modal');
});

</script>